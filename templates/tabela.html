<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ titulo }}</title>
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 80px; }
        .table-hover tbody tr:hover { background-color: #e9ecef; }
        .btn-floating-route {
            position: fixed; bottom: 20px; right: 20px; z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3); border-radius: 50px;
            padding: 12px 24px; font-size: 1.1rem; display: none;
        }
        .text-complemento { font-size: 0.85rem; color: #6c757d; display: block; margin-top: 2px;}
    </style>
</head>
<body>

    <nav class="navbar navbar-dark bg-dark mb-4 shadow sticky-top">
        <div class="container">
            <a class="btn btn-outline-light" href="{{ url_for('index') }}">
                <i class="bi bi-arrow-left"></i> Voltar
            </a>
            <span class="navbar-text text-white fw-bold d-none d-md-block">{{ titulo }}</span>
            <button class="btn btn-primary fw-bold" data-bs-toggle="modal" data-bs-target="#modalAdicionar">
                <i class="bi bi-plus-lg"></i> Adicionar
            </button>
        </div>
    </nav>

    <div class="container">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }} alert-dismissible fade show shadow-sm">
                        {{ message }} <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}

        {% if registros %}
        <div class="d-flex justify-content-end mb-2">
            <button class="btn btn-sm btn-outline-secondary" onclick="alternarSelecao()">
                <i class="bi bi-check-all"></i> Marcar/Desmarcar Todos
            </button>
        </div>
        {% endif %}

        <div class="card shadow border-0">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-striped table-hover mb-0 align-middle">
                        <thead class="table-dark text-center">
                            <tr>
                                <th style="width: 40px;"><i class="bi bi-check2-square"></i></th>
                                <th style="width: 50px;">#</th>
                                <th class="text-start">Empresa</th>
                                <th class="text-start">Endere√ßo de Coleta</th>
                                <th style="width: 110px;">A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="listaEnderecos">
                            {% for item in registros %}
                            <tr>
                                <td class="text-center">
                                    <input class="form-check-input checkbox-rota" type="checkbox" 
                                           value="{{ item.Endere√ßo }}" 
                                           onchange="atualizarBotaoRota()">
                                </td>
                                <td class="text-center fw-bold text-muted">{{ loop.index }}</td>
                                <td class="fw-semibold">{{ item.Empresa }}</td>
                                <td>
                                    <a href="https://www.google.com/maps/search/?api=1&query={{ item.Endere√ßo }}" target="_blank" class="text-decoration-none fw-bold text-primary">
                                        <i class="bi bi-geo-alt-fill text-danger"></i> {{ item.Endere√ßo }}
                                    </a>
                                    {% if item.Complemento %}
                                        <span class="text-complemento">
                                            <i class="bi bi-info-circle-fill" style="font-size: 0.7rem;"></i> {{ item.Complemento }}
                                        </span>
                                    {% endif %}
                                </td>
                                <td class="text-center">
                                    <button class="btn btn-sm btn-outline-primary" 
                                            onclick="preencherModalEditar('{{ item.id }}', '{{ item.Empresa }}', '{{ item.Endere√ßo }}', '{{ item.Complemento }}')"
                                            data-bs-toggle="modal" data-bs-target="#modalEditar">
                                        <i class="bi bi-pencil"></i>
                                    </button>
                                    <a href="{{ url_for('excluir', nome_rota=nome_rota, id_linha=item.id) }}" 
                                       class="btn btn-sm btn-outline-danger"
                                       onclick="return confirm('Excluir esta empresa?')">
                                        <i class="bi bi-trash"></i>
                                    </a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">Nenhuma empresa cadastrada.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <button id="btnRota" class="btn btn-success btn-floating-route" onclick="abrirRotaNoMaps()">
        <i class="bi bi-map-fill"></i> Iniciar Rota (<span id="contadorRota">0</span>)
    </button>

    <div class="modal fade" id="modalAdicionar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{{ url_for('adicionar', nome_rota=nome_rota) }}" method="POST">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">Nova Coleta</h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="fw-bold">Empresa</label>
                            <input type="text" class="form-control" name="empresa" required>
                        </div>
                        
                        <div class="row g-2">
                            <div class="col-12">
                                <label class="fw-bold text-danger">Endere√ßo (GPS)</label>
                                <input type="text" class="form-control" name="endereco" required placeholder="Ex: Av. Brasil, 500">
                                <div class="form-text">Somente rua e n√∫mero. O Maps usar√° este campo.</div>
                            </div>
                            <div class="col-12 mt-2">
                                <label class="fw-bold text-secondary">Complemento (Obs)</label>
                                <input type="text" class="form-control" name="complemento" placeholder="Ex: Bloco B, Apto 102, Falar com Jo√£o">
                                <div class="form-text">Informa√ß√µes extras para o motorista.</div>
                            </div>
                        </div>

                        <hr>
                        <div class="mb-3">
                            <label class="fw-bold text-primary">Posi√ß√£o na rota</label>
                            <select class="form-select" name="posicao">
                                <option value="fim" selected>üîª No Final</option>
                                <option value="inicio">üî∫ No In√≠cio</option>
                                {% if registros %}
                                <optgroup label="Depois de:">
                                    {% for item in registros %}
                                        <option value="{{ item.id }}">{{ loop.index }} - {{ item.Empresa }}</option>
                                    {% endfor %}
                                </optgroup>
                                {% endif %}
                            </select>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-success">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalEditar" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <form action="{{ url_for('editar', nome_rota=nome_rota) }}" method="POST">
                    <input type="hidden" name="id_linha" id="editId">
                    <div class="modal-header bg-warning">
                        <h5 class="modal-title">Editar</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="fw-bold">Empresa</label>
                            <input type="text" class="form-control" name="empresa" id="editEmpresa" required>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold text-danger">Endere√ßo (GPS)</label>
                            <input type="text" class="form-control" name="endereco" id="editEndereco" required>
                        </div>
                        <div class="mb-3">
                            <label class="fw-bold text-secondary">Complemento</label>
                            <input type="text" class="form-control" name="complemento" id="editComplemento">
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                        <button type="submit" class="btn btn-primary">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // Agora recebe tamb√©m o complemento para preencher o formul√°rio
        function preencherModalEditar(id, empresa, endereco, complemento) {
            document.getElementById('editId').value = id;
            document.getElementById('editEmpresa').value = empresa;
            document.getElementById('editEndereco').value = endereco;
            document.getElementById('editComplemento').value = complemento;
        }

        function atualizarBotaoRota() {
            const checkboxes = document.querySelectorAll('.checkbox-rota:checked');
            const btn = document.getElementById('btnRota');
            document.getElementById('contadorRota').innerText = checkboxes.length;
            btn.style.display = checkboxes.length > 0 ? 'block' : 'none';
        }

        function alternarSelecao() {
            const checkboxes = document.querySelectorAll('.checkbox-rota');
            const algumaDesmarcada = Array.from(checkboxes).some(c => !c.checked);
            checkboxes.forEach(c => c.checked = algumaDesmarcada);
            atualizarBotaoRota();
        }

        function abrirRotaNoMaps() {
            const checkboxes = document.querySelectorAll('.checkbox-rota:checked');
            if (checkboxes.length === 0) return;

            // Pega APENAS o value (que √© o endere√ßo puro)
            let enderecos = Array.from(checkboxes).map(c => c.value);
            
            // O Maps vai abrir ignorando os complementos visuais
            const baseURL = "https://www.google.com/maps/dir/";
            const origin = "My Location"; 
            
            // Monta a URL no formato novo do Maps que aceita melhor waypoints
            // Formato: dir/Origem/Parada1/Parada2/Destino
            
            let rota = enderecos.map(e => encodeURIComponent(e)).join("/");
            const finalURL = `${baseURL}${origin}/${rota}`;
            
            window.open(finalURL, '_blank');
        }
    </script>
</body>
</html>
